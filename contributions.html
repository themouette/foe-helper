<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Contributions</title>
    <style type="text/css" media="screen">
      #drop-area {
        width: 500px;
        height: 300px;
        background-color: #cecece;
      }
    </style>
  </head>
  <body>
    <div id="drop-area"></div>
    <input type="file" id="file-selector" multiple />
    <div><pre id="result"></pre></div>

    <!-- https://raw.githubusercontent.com/adaltas/node-csv/79939aee56c467ab8f866eac3ebc591279b2f6f2/packages/csv/dist/iife/index.js -->
    <script src="./3rd-party/node-csv.js" charset="utf-8"></script>
    <script charset="utf-8">
      const ages = [
        "Âge de Fer",
        "Haut Moyen Âge",
        "Moyen Âge Classique",
        "Renaissance",
        "Âge Colonial",
        "Âge Industriel",
        "Ère Progressiste",
        "Ère Moderne",
        "Ère Postmoderne",
        "Ère Contemporaine",
        "Ère de Demain",
        "Ère du Futur",
        "Futur Arctique",
        "Futur Océanique",
        "Futur Virtuel",
        "Ère Spatiale - Mars",
        "Ère Spatiale - Ceinture d'Astéroïdes",
        "Ère Spatiale - Vénus",
        "Ère Spatiale - Lune de Jupiter",
        "Ère Spatiale - Titan",
      ];
      const mapResourceToEra = {
        Tissu: "Âge de Fer",
        "Bois d'ébène": "Âge de Fer",
        Bijou: "Âge de Fer",
        Fer: "Âge de Fer",
        Calcaire: "Âge de Fer",
        Cuivre: "Haut Moyen Âge",
        Or: "Haut Moyen Âge",
        Granite: "Haut Moyen Âge",
        Miel: "Haut Moyen Âge",
        Albâtre: "Haut Moyen Âge",
        Brique: "Moyen Âge Classique",
        Verre: "Moyen Âge Classique",
        "Herbes séchées": "Moyen Âge Classique",
        Corde: "Moyen Âge Classique",
        Sel: "Moyen Âge Classique",
        Basalte: "Renaissance",
        Laiton: "Renaissance",
        "Poudre à canon": "Renaissance",
        Soie: "Renaissance",
        "Poudre à talquer": "Renaissance",
        Café: "Âge Colonial",
        Papier: "Âge Colonial",
        Porcelaine: "Âge Colonial",
        Goudron: "Âge Colonial",
        Fil: "Âge Colonial",
        Coke: "Âge Industriel",
        Engrais: "Âge Industriel",
        Caoutchouc: "Âge Industriel",
        Textiles: "Âge Industriel",
        "Huile de baleine": "Âge Industriel",
        Amiante: "Ère Progressiste",
        Explosifs: "Ère Progressiste",
        "Pièces détachées": "Ère Progressiste",
        Essence: "Ère Progressiste",
        "Fer-blanc": "Ère Progressiste",
        "Plat cuisiné": "Ère Moderne",
        "Béton armé": "Ère Moderne",
        Arômes: "Ère Moderne",
        "Produits de luxe": "Ère Moderne",
        Emballage: "Ère Moderne",
        "Donnée génétique": "Ère Postmoderne",
        "Filtres industriels": "Ère Postmoderne",
        "Ressources renouvelables": "Ère Postmoderne",
        "Semi-conducteurs": "Ère Postmoderne",
        Acier: "Ère Postmoderne",
        "Donnée bionique": "Ère Contemporaine",
        "Électro-aimants": "Ère Contemporaine",
        Gaz: "Ère Contemporaine",
        Plastique: "Ère Contemporaine",
        Robots: "Ère Contemporaine",
        "Recherche en nutrition": "Ère de Demain",
        "Liant papier": "Ère de Demain",
        Conservateurs: "Ère de Demain",
        "Matériaux intelligents": "Ère de Demain",
        "Béton translucide": "Ère de Demain",
        Algue: "Ère du Futur",
        "Donnée biogéochimique": "Ère du Futur",
        Nanoparticules: "Ère du Futur",
        "Eau purifiée": "Ère du Futur",
        Supraconducteurs: "Ère du Futur",
        "Donnée d'I.A.": "Futur Arctique",
        Bioplastiques: "Futur Arctique",
        Nanocâble: "Futur Arctique",
        "Piles en papier": "Futur Arctique",
        "Gaz transester": "Futur Arctique",
        "Écailles artificielles": "Futur Océanique",
        "Substance bioluminescente": "Futur Océanique",
        Coraux: "Futur Océanique",
        Perles: "Futur Océanique",
        Plancton: "Futur Océanique",
        "Crypto-monnaie": "Futur Virtuel",
        "Cristaux de données": "Futur Virtuel",
        "Riz doré": "Futur Virtuel",
        Nanorobots: "Futur Virtuel",
        "Soie de thé": "Futur Virtuel",
        "Cultures biotechnologiques": "Ère Spatiale - Mars",
        "Réacteurs de fusion": "Ère Spatiale - Mars",
        "Huiles de graissage": "Ère Spatiale - Mars",
        "Microbes martiens": "Ère Spatiale - Mars",
        Superalliages: "Ère Spatiale - Mars",
        Brome: "Ère Spatiale - Ceinture d'Astéroïdes",
        "Fluide composé": "Ère Spatiale - Ceinture d'Astéroïdes",
        Nickel: "Ère Spatiale - Ceinture d'Astéroïdes",
        "Cristal de platine": "Ère Spatiale - Ceinture d'Astéroïdes",
        "Matériau transformé": "Ère Spatiale - Ceinture d'Astéroïdes",
        "Algue lumineuse": "Ère Spatiale - Vénus",
        "En-cas d'herbe": "Ère Spatiale - Vénus",
        "Suppléments de micropousse": "Ère Spatiale - Vénus",
        "Protéines de soja": "Ère Spatiale - Vénus",
        "Cristaux de sucre": "Ère Spatiale - Vénus",
        "Données ADN avancées": "Ère Spatiale - Lune de Jupiter",
        "Créatures biologiques": "Ère Spatiale - Lune de Jupiter",
        "Porifère avancé": "Ère Spatiale - Lune de Jupiter",
        "Algues rouges": "Ère Spatiale - Lune de Jupiter",
        "Dossiers topologiques": "Ère Spatiale - Lune de Jupiter",
        "Capsule de matière comprimée": "Ère Spatiale - Titan",
        "Donnée expérimentale": "Ère Spatiale - Titan",
        "Molécule isolée": "Ère Spatiale - Titan",
        "Liant liquide": "Ère Spatiale - Titan",
        "Hydrocarbure upcyclé": "Ère Spatiale - Titan",
      };
      const mapEraToShortName = {
        "Âge de Fer": "AdF",
        "Haut Moyen Âge": "HMA",
        "Moyen Âge Classique": "MA Classique",
        Renaissance: "Renaissance",
        "Âge Colonial": "Colo",
        "Âge Industriel": "Indus",
        "Ère Progressiste": "Progressiste",
        "Ère Moderne": "Moderne",
        "Ère Postmoderne": "Postmoderne",
        "Ère Contemporaine": "Contemporaine",
        "Ère de Demain": "Demain",
        "Ère du Futur": "Futur",
        "Futur Arctique": "FA",
        "Futur Océanique": "FO",
        "Futur Virtuel": "FV",
        "Ère Spatiale - Mars": "Mars",
        "Ère Spatiale - Ceinture d'Astéroïdes": "Astéroïdes",
        "Ère Spatiale - Vénus": "Vénus",
        "Ère Spatiale - Lune de Jupiter": "Jupiter",
        "Ère Spatiale - Titan": "Titan",
      };

      function groupResourceCountByEra(countsByResource) {
        const countsByAge = {};
        Object.keys(countsByResource).forEach((resourceName) => {
          const age = mapResourceToEra[resourceName] || "Sans Age";
          if (!mapResourceToEra[resourceName]) {
            console.log(resourceName);
          }
          const shortAgeName = mapEraToShortName[age] || age;
          countsByAge[shortAgeName] =
            (countsByAge[shortAgeName] || 0) + countsByResource[resourceName];
        });

        return countsByAge;
      }

      const fileSelector = document.getElementById("file-selector");
      fileSelector.addEventListener("change", (event) => {
        const fileList = event.target.files;
        readCsvFiles(fileList);
      });

      const dropArea = document.getElementById("drop-area");
      dropArea.addEventListener("dragover", (event) => {
        event.stopPropagation();
        event.preventDefault();
        // Style the drag-and-drop as a "copy file" operation.
        event.dataTransfer.dropEffect = "copy";
      });

      dropArea.addEventListener("drop", (event) => {
        event.stopPropagation();
        event.preventDefault();
        const fileList = event.dataTransfer.files;
        readCsvFiles(fileList);
      });
      function decodeBase64(base64) {
        const text = atob(base64);
        const length = text.length;
        const bytes = new Uint8Array(length);
        for (let i = 0; i < length; i++) {
          bytes[i] = text.charCodeAt(i);
        }
        const decoder = new TextDecoder(); // default is utf-8
        return decoder.decode(bytes);
      }
      const toNumber = (x) => Number(x.replaceAll(/[^-\d]/g, ""));
      const formatGoods = (goods) => {
        return Object.keys(goods).map((name) => `${name} (${goods[name]})`);
      };

      function readSingleFile(file) {
        // Check if the file is CSV
        if (
          file.type &&
          !(
            (
              file.type.startsWith("text/csv") || // standard
              file.type.startsWith("application/vnd.ms-excel")
            ) // Windows...
          )
        ) {
          console.log("File is not a CSV file", file.type, file);
          return "";
        }

        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.addEventListener("load", (event) => {
            let fileContent = event.target.result.replace(
              /data:[^;]*;base64,/,
              ""
            );
            fileContent = decodeBase64(fileContent).replace(
              // FR => EN
              "ID Joueur;Nom du joueur;Ère;Ressource;Montant;Message;Date/Heure",
              "Player ID;Player name;Era;Good;Amount;Message;Date/Time"
            );
            resolve(fileContent);
          });
          reader.readAsDataURL(file);
        });
      }
      function csvToJson(csvString) {
        return new Promise((resolve, reject) => {
          csv.parse(
            csvString,
            { delimiter: ";", columns: true },
            (err, result) => {
              if (err) return reject(err);
              resolve(result);
            }
          );
        });
      }
      function compileStatsFromRows(rows) {
        console.log(rows);
        // Group by member
        // each member is an object:
        // {
        //   monuments: { algues: 12, ... },
        //   donnation: { algues: 12, ... },
        //   total: 123
        // }
        const byMember = {};
        // Global guild statistics
        // {
        //   donnation: { algues: 12, ... },
        //   monuments: { algues: 12, ... },
        //   cdg: { algues: 12, ... },
        //   gcg: {},
        //   eg: {},
        //   unknownEvents: [],
        //   total_contributions: 123,
        //   total_spent: 110,
        //   balance: {},
        // }
        const stats = {
          all: {},
          monuments: {},
          donnation: {},
          cdg: {},
          eg: {},
          gcg: {},
          unknownEvents: [],
          total_contributions: 0,
          total_spent: 0,
          balance: 0,
        };

        rows.forEach(({ Message, Good, "Player name": playerName, Amount }) => {
          byMember[playerName] = byMember[playerName] || {
            monuments: {},
            donnation: {},
            total: 0,
          };

          stats.balance += toNumber(Amount);
          stats.all[Good] = (stats.all[Good] || 0) + toNumber(Amount);
          if (toNumber(Amount) < 0) {
            stats.total_spent -= toNumber(Amount);
          } else {
            byMember[playerName].total += toNumber(Amount);
            stats.total_contributions += toNumber(Amount);
          }

          if (Message === "Production de bâtiment") {
            byMember[playerName].monuments[Good] =
              (byMember[playerName].monuments[Good] || 0) + toNumber(Amount);
            stats.monuments[Good] =
              (stats.monuments[Good] || 0) + toNumber(Amount);
          } else if (Message === "Dons à la trésorerie de la guilde") {
            byMember[playerName].donnation[Good] =
              (byMember[playerName].donnation[Good] || 0) + toNumber(Amount);
            stats.donnation[Good] =
              (stats.donnation[Good] || 0) + toNumber(Amount);
          } else if (Message.startsWith("Champs de bataille")) {
            stats.cdg[Good] = (stats.cdg[Good] || 0) + toNumber(Amount);
          } else if (Message.startsWith("Déploiement de l'armée de siège")) {
            stats.gcg[Good] = (stats.gcg[Good] || 0) + toNumber(Amount);
          } else if (Message.startsWith("Expédition de guilde")) {
            stats.eg[Good] = (stats.eg[Good] || 0) + toNumber(Amount);
          } else {
            stats.unknownEvents = [...stats.unknownEvents, Message];
          }
        });

        return { byMember, ...stats };
      }

      function formatStats({ byMember, ...stats }) {
        const allStatsButByAge = groupResourceCountByEra(stats.all);
        return `
Contribution des membres:
${Object.keys(byMember)
  .map(
    (name) =>
      `- ${name}: (${byMember[name].total})${
        Object.keys(byMember[name].donnation).length
          ? ", dons: " + formatGoods(byMember[name].donnation)
          : ""
      }\n`
  )
  .join("")}

Batiments Champs de bataille:
- ${formatGoods(stats.cdg).join("\n- ")}

Expédition de guilde:
- ${formatGoods(stats.eg).join("\n- ")}

Continent Des Guildes:
- ${formatGoods(stats.gcg).join("\n- ")}

Dons:
${Object.keys(byMember)
  .filter((name) => Object.keys(byMember[name].donnation).length > 0)
  .map((name) => `- ${name}: ${formatGoods(byMember[name].donnation)}\n`)
  .join("")}

Bilan: ${stats.total_contributions} - ${stats.total_spent} = ${stats.balance}

Detail par age:
${Object.keys(allStatsButByAge)
  .sort((nameA, nameB) => allStatsButByAge[nameA] - allStatsButByAge[nameB])
  .map((name) => `- ${name} (${allStatsButByAge[name]})\n`)
  .join("")}

Detail par resource:
${Object.keys(stats.all)
  .sort((nameA, nameB) => stats.all[nameA] - stats.all[nameB])
  .map((name) => `- ${name} (${stats.all[name]})\n`)
  .join("")}

${
  stats.unknownEvents.length
    ? "Evenements inconnus:\n - " +
      Array.from(new Set(stats.unknownEvents)).join("\n - ")
    : ""
}
                          `;
      }

      function readCsvFiles(files) {
        Promise.all(Array.from(files).map(readSingleFile))
          .then((csvStrings) => Promise.all(csvStrings.map(csvToJson)))
          .then((rows) => rows.flatMap((x) => x))
          .then(compileStatsFromRows)
          .then(formatStats)
          .then(
            (content) => (document.querySelector("#result").innerText = content)
          )
          .catch((error) => console.log(error));
      }
    </script>
  </body>
</html>
